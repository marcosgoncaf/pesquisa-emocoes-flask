<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Pesquisador (H√≠brido)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; }
        .item-card { background: #fff; border: 2px solid #eee; padding: 25px; margin-top: 25px; border-radius: 10px; position: relative; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-green { background: #2ecc71; color: white; width: 100%; font-size: 16px; margin-top: 30px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .cols-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .type-selector { margin: 15px 0; background: #f0f0f0; padding: 10px; border-radius: 5px; display: flex; gap: 20px; }
        .type-selector label { display: flex; align-items: center; cursor: pointer; font-weight: normal; margin: 0; }
        .input-hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Novo Estudo</h1>
    <input type="text" id="study_name" placeholder="Nome do Estudo">
    <textarea id="welcome_message" rows="2" placeholder="Mensagem de Boas-vindas"></textarea>
    
    <div id="items-container"></div>
    
    <button class="btn" style="background:#3498db; color:white; margin-top:20px;" onclick="addItem()">+ Adicionar Amostra</button>
    <button class="btn btn-green" onclick="saveStudy()">üíæ SALVAR E GERAR LINK</button>

    <div id="result-area" style="display:none; margin-top:20px; padding:20px; background:#dff0d8;">
        <h3>Sucesso!</h3>
        <code id="final-link" style="word-break: break-all;"></code>
    </div>
</div>

<script>
    function addItem() {
        const id = Date.now();
        const html = `
            <div class="item-card" id="card-${id}">
                <button onclick="document.getElementById('card-${id}').remove()" style="float:right; color:red; border:none; background:none; cursor:pointer;">Excluir</button>
                <h3 style="margin-top:0; color:#555">Amostra</h3>
                
                <label>Nome / C√≥digo:</label>
                <input type="text" class="i-name" placeholder="Ex: Amostra 1">

                <div class="type-selector">
                    <label><input type="radio" name="type-${id}" value="upload" checked onclick="toggleInput('${id}', 'upload')"> üìÇ Fazer Upload</label>
                    <label><input type="radio" name="type-${id}" value="url" onclick="toggleInput('${id}', 'url')"> üîó Link Direto</label>
                </div>

                <div id="input-upload-${id}">
                    <label>Selecione o Arquivo:</label>
                    <input type="file" class="i-file" accept="image/*,video/*">
                </div>

                <div id="input-url-${id}" class="input-hidden">
                    <label>Cole a URL (Imagem ou V√≠deo MP4):</label>
                    <input type="text" class="i-url" placeholder="https://...">
                </div>
                
                <label>Legenda:</label>
                <input type="text" class="i-caption">
                
                <div class="cols-2" style="margin-top:10px">
                    <div>
                        Tempo (s): <input type="number" class="i-duration" value="5">
                        FPS: <input type="number" class="i-fps" value="3">
                    </div>
                    <div>
                        <label><input type="checkbox" class="i-q-liking" checked> Nota</label> 
                        <label><input type="checkbox" class="i-q-emotions" checked> Emo√ß√µes</label> 
                        <label><input type="checkbox" class="i-q-word"> Palavra</label>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('items-container').insertAdjacentHTML('beforeend', html);
    }

    function toggleInput(id, type) {
        if(type === 'upload') {
            document.getElementById(`input-upload-${id}`).style.display = 'block';
            document.getElementById(`input-url-${id}`).style.display = 'none';
        } else {
            document.getElementById(`input-upload-${id}`).style.display = 'none';
            document.getElementById(`input-url-${id}`).style.display = 'block';
        }
    }

    async function saveStudy() {
        const name = document.getElementById('study_name').value;
        if (!name) return alert("D√™ um nome ao estudo.");

        const formData = new FormData();
        formData.append('study_name', name);
        formData.append('welcome_message', document.getElementById('welcome_message').value);

        const cards = document.querySelectorAll('.item-card');
        if(cards.length === 0) return alert("Adicione itens.");

        let error = false;
        cards.forEach((card, index) => {
            // Verifica qual modo est√° selecionado (Upload ou URL)
            const isUpload = card.querySelector(`input[value="upload"]`).checked;
            const fileInput = card.querySelector('.i-file');
            const urlInput = card.querySelector('.i-url');

            formData.append(`items[${index}][name]`, card.querySelector('.i-name').value);
            formData.append(`items[${index}][caption]`, card.querySelector('.i-caption').value);
            formData.append(`items[${index}][duration]`, card.querySelector('.i-duration').value);
            formData.append(`items[${index}][fps]`, card.querySelector('.i-fps').value);
            
            // Envia o tipo de input
            formData.append(`items[${index}][inputType]`, isUpload ? 'upload' : 'url');

            if (isUpload) {
                if(fileInput.files.length > 0) {
                    formData.append(`items[${index}][file]`, fileInput.files[0]);
                } else {
                    error = true;
                }
            } else {
                if(urlInput.value) {
                    formData.append(`items[${index}][directUrl]`, urlInput.value);
                } else {
                    error = true;
                }
            }

            formData.append(`items[${index}][q_liking]`, card.querySelector('.i-q-liking').checked);
            formData.append(`items[${index}][q_emotions]`, card.querySelector('.i-q-emotions').checked);
            formData.append(`items[${index}][q_word]`, card.querySelector('.i-q-word').checked);
        });

        if(error) return alert("Preencha os arquivos ou links de todos os itens.");

        const btn = document.querySelector('.btn-green');
        btn.innerText = "‚è≥ Enviando... (Aguarde)";
        btn.disabled = true;

        try {
            const res = await fetch('/create_study', { method: 'POST', body: formData });
            const data = await res.json();
            
            if(data.status === 'success') {
                document.getElementById('result-area').style.display = 'block';
                document.getElementById('final-link').innerText = data.link;
                btn.innerText = "‚úÖ Sucesso!";
            } else {
                alert("Erro: " + data.message);
                btn.disabled = false; btn.innerText = "Salvar";
            }
        } catch(e) {
            alert("Erro de conex√£o");
            btn.disabled = false; btn.innerText = "Salvar";
        }
    }
    addItem();
</script>
</body>
</html>