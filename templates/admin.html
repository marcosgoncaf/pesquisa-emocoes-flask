<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Pesquisador (Drive Upload)</title>
    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1 { margin-bottom: 20px; color: #2c3e50; }
        
        .item-card { background: #fff; border: 2px solid #eee; padding: 25px; margin-top: 25px; border-radius: 10px; position: relative; }
        .item-card:hover { border-color: #ccc; }
        
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 14px; }
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .cols-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .checkbox-group label { display: inline-flex; align-items: center; font-weight: normal; margin-right: 15px; cursor: pointer; }
        .checkbox-group input { margin-right: 5px; }

        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add { background: #3498db; color: white; margin-top: 20px; }
        .btn-green { background: #2ecc71; color: white; width: 100%; font-size: 16px; margin-top: 30px; }
        .btn-del { position: absolute; top: 15px; right: 15px; background: transparent; color: #e74c3c; border: 1px solid #e74c3c; padding: 5px 10px; font-size: 12px; }
        .btn-del:hover { background: #e74c3c; color: white; }

        #result-area { display:none; margin-top:30px; padding:20px; background:#dff0d8; border: 1px solid #d6e9c6; border-radius: 6px; }
        code { display: block; background: rgba(255,255,255,0.5); padding: 10px; margin-top: 10px; word-break: break-all; font-family: monospace; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Novo Estudo (Upload Drive) ‚òÅÔ∏è</h1>
    
    <label>Nome do Estudo</label>
    <input type="text" id="study_name" placeholder="Ex: Teste de Embalagens - V√≠deo">
    
    <label>Mensagem de Boas-vindas</label>
    <textarea id="welcome_message" rows="2" placeholder="Instru√ß√µes para o participante..."></textarea>
    
    <div id="items-container"></div>
    
    <button class="btn btn-add" onclick="addItem()">+ Adicionar Amostra</button>
    <button class="btn btn-green" onclick="saveStudy()">üíæ FAZER UPLOAD E GERAR LINK</button>

    <div id="result-area">
        <h3 style="margin-top:0">Estudo Criado!</h3>
        <p>Link para enviar aos participantes:</p>
        <code id="final-link"></code>
    </div>
</div>

<script>
    function addItem() {
        const id = Date.now();
        const html = `
            <div class="item-card" id="card-${id}">
                <button class="btn btn-del" onclick="document.getElementById('card-${id}').remove()">Remover</button>
                <h3 style="margin-top:0; color:#555">Amostra</h3>
                
                <label>Nome / C√≥digo ID:</label>
                <input type="text" class="i-name" placeholder="Ex: Amostra A">
                
                <label>Arquivo (Imagem ou V√≠deo MP4):</label>
                <input type="file" class="i-file" accept="image/*,video/*">
                
                <label>Legenda (Opcional):</label>
                <input type="text" class="i-caption">
                
                <div class="cols-2">
                    <div style="background:#f9f9f9; padding:10px; border-radius:5px;">
                        <label style="margin-top:0">Tempo de Exibi√ß√£o (s):</label>
                        <input type="number" class="i-duration" value="5" min="1">
                        
                        <label>Captura (FPS):</label>
                        <input type="number" class="i-fps" value="3" min="1" max="10">
                    </div>
                    <div style="background:#f9f9f9; padding:10px; border-radius:5px;">
                        <label style="margin-top:0">Perguntas:</label>
                        <div class="checkbox-group" style="margin-top:10px">
                            <label><input type="checkbox" class="i-q-liking" checked> Nota</label>
                            <label><input type="checkbox" class="i-q-emotions" checked> Emo√ß√µes</label><br>
                            <label><input type="checkbox" class="i-q-word"> Palavra</label>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('items-container').insertAdjacentHTML('beforeend', html);
    }

    async function saveStudy() {
        const name = document.getElementById('study_name').value;
        if (!name) return alert("D√™ um nome ao estudo.");

        const cards = document.querySelectorAll('.item-card');
        if(cards.length === 0) return alert("Adicione pelo menos uma amostra.");

        const formData = new FormData();
        formData.append('study_name', name);
        formData.append('welcome_message', document.getElementById('welcome_message').value);

        let error = false;
        cards.forEach((card, index) => {
            const fileInput = card.querySelector('.i-file');
            if(fileInput.files.length === 0) { error = true; return; }

            formData.append(`items[${index}][name]`, card.querySelector('.i-name').value);
            formData.append(`items[${index}][file]`, fileInput.files[0]);
            formData.append(`items[${index}][caption]`, card.querySelector('.i-caption').value);
            formData.append(`items[${index}][duration]`, card.querySelector('.i-duration').value);
            formData.append(`items[${index}][fps]`, card.querySelector('.i-fps').value);
            
            formData.append(`items[${index}][q_liking]`, card.querySelector('.i-q-liking').checked);
            formData.append(`items[${index}][q_emotions]`, card.querySelector('.i-q-emotions').checked);
            formData.append(`items[${index}][q_word]`, card.querySelector('.i-q-word').checked);
        });

        if(error) return alert("Todas as amostras precisam de um arquivo selecionado.");

        const btn = document.querySelector('.btn-green');
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ Enviando arquivos para o Drive... (N√£o feche)";
        btn.disabled = true;

        try {
            const res = await fetch('/create_study', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if(data.status === 'success') {
                document.getElementById('result-area').style.display = 'block';
                document.getElementById('final-link').innerText = data.link;
                btn.innerText = "‚úÖ Sucesso!";
                window.scrollTo(0, document.body.scrollHeight);
            } else {
                alert("Erro no servidor: " + data.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        } catch(e) {
            alert("Erro de conex√£o. Se o arquivo for v√≠deo grande, pode ter demorado muito.");
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    
    // Adiciona o primeiro item automaticamente
    addItem();
</script>
</body>
</html>