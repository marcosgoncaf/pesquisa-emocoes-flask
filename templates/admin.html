<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Pesquisador (Google Drive)</title>
    <style>
        /* (Mantenha o mesmo CSS bonito do anterior, vou omitir para economizar espa√ßo) */
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; }
        .item-card { background: #fff; border: 2px solid #eee; padding: 25px; margin-top: 25px; border-radius: 10px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-green { background: #2ecc71; color: white; width: 100%; font-size: 16px; margin-top: 30px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; }
        .cols-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Novo Estudo (Upload via Drive) ‚òÅÔ∏è</h1>
    <input type="text" id="study_name" placeholder="Nome do Estudo">
    <textarea id="welcome_message" rows="3" placeholder="Mensagem de Boas-vindas"></textarea>
    
    <div id="items-container"></div>
    
    <button class="btn" style="background:#ddd; margin-top:20px;" onclick="addItem()">+ Adicionar Amostra</button>
    <button class="btn btn-green" onclick="saveStudy()">üíæ FAZER UPLOAD E GERAR LINK</button>

    <div id="result-area" style="display:none; margin-top:20px; padding:20px; background:#dff0d8;">
        <h3>Sucesso!</h3>
        <code id="final-link"></code>
    </div>
</div>

<script>
    function addItem() {
        const id = Date.now();
        // Note que o input file agora n√£o tem "onchange" complexo, vamos pegar o arquivo direto no final
        const html = `
            <div class="item-card" id="card-${id}">
                <div style="float:right"><button onclick="document.getElementById('card-${id}').remove()" style="color:red;border:none;background:none">X</button></div>
                <h3>Amostra</h3>
                
                <label>Nome/ID:</label>
                <input type="text" class="i-name">
                
                <label>Arquivo (Imagem ou V√≠deo):</label>
                <input type="file" class="i-file" accept="image/*,video/*">
                
                <label>Legenda:</label>
                <input type="text" class="i-caption">
                
                <div class="cols-2" style="margin-top:10px">
                    <div>
                        Tempo (s): <input type="number" class="i-duration" value="5">
                        FPS: <input type="number" class="i-fps" value="3">
                    </div>
                    <div>
                        <label><input type="checkbox" class="i-q-liking" checked> Gostar</label><br>
                        <label><input type="checkbox" class="i-q-emotions" checked> Emo√ß√µes</label><br>
                        <label><input type="checkbox" class="i-q-word"> Palavra</label>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('items-container').insertAdjacentHTML('beforeend', html);
    }

    async function saveStudy() {
        const name = document.getElementById('study_name').value;
        const btn = document.querySelector('.btn-green');
        
        const formData = new FormData();
        formData.append('study_name', name);
        formData.append('welcome_message', document.getElementById('welcome_message').value);

        const cards = document.querySelectorAll('.item-card');
        if(cards.length === 0) return alert("Adicione itens");

        let hasFileError = false;
        cards.forEach((card, index) => {
            const fileInput = card.querySelector('.i-file');
            if(fileInput.files.length === 0) hasFileError = true;

            // Aqui constru√≠mos o pacote para o Python
            formData.append(`items[${index}][name]`, card.querySelector('.i-name').value);
            formData.append(`items[${index}][file]`, fileInput.files[0]); // Envia o arquivo bin√°rio
            formData.append(`items[${index}][caption]`, card.querySelector('.i-caption').value);
            formData.append(`items[${index}][duration]`, card.querySelector('.i-duration').value);
            formData.append(`items[${index}][fps]`, card.querySelector('.i-fps').value);
            
            formData.append(`items[${index}][q_liking]`, card.querySelector('.i-q-liking').checked);
            formData.append(`items[${index}][q_emotions]`, card.querySelector('.i-q-emotions').checked);
            formData.append(`items[${index}][q_word]`, card.querySelector('.i-q-word').checked);
        });

        if(hasFileError) return alert("Todos os itens precisam de um arquivo!");

        btn.innerText = "‚è≥ Enviando arquivos para o Drive... (Aguarde)";
        btn.disabled = true;

        try {
            const res = await fetch('/create_study', {
                method: 'POST',
                body: formData // Enviamos FormData, n√£o JSON
            });
            const data = await res.json();
            
            if(data.status === 'success') {
                document.getElementById('result-area').style.display = 'block';
                document.getElementById('final-link').innerText = data.link;
                btn.innerText = "‚úÖ Sucesso!";
            } else {
                alert("Erro: " + data.message);
                btn.disabled = false;
                btn.innerText = "üíæ Tentar Novamente";
            }
        } catch(e) {
            alert("Erro de conex√£o");
            btn.disabled = false;
            btn.innerText = "üíæ Tentar Novamente";
        }
    }
    addItem();
</script>
</body>
</html>