<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudo Sensorial</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #F8F9FA; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; align-items: center; }
        .container { max-width: 500px; width: 100%; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        #video-wrapper { position: relative; width: 100%; max-width: 320px; margin: 20px auto; border-radius: 15px; overflow: hidden; background: #000; }
        video { width: 100%; transform: scaleX(-1); display: block; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .active { display: block; }
        button { background: #2c3e50; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 20px; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .stimulus-media { width: 100%; max-height: 400px; object-fit: contain; border-radius: 10px; margin: 20px auto; display: block; }
        #progress-bar { width: 0%; background: #2ecc71; height: 6px; transition: width 0.1s linear; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div id="p-welcome" class="page active">
        <h1>Bem-vindo</h1>
        <p id="welcome-text">Carregando...</p>
        <div id="video-wrapper"><video id="videoElement" autoplay playsinline muted></video></div>
        <p id="status-msg" style="color: orange;">Aguardando câmera...</p>
        <input type="text" id="participant_id" placeholder="Seu Nome ou ID" autocomplete="off">
        <button id="btn-start" disabled onclick="startExperiment()">INICIAR</button>
    </div>

    <div id="p-stimulus" class="page">
        <h2 style="color:#555">Observe...</h2>
        <img id="stimulus-img" class="stimulus-media" style="display:none">
        <video id="stimulus-vid" class="stimulus-media" autoplay muted playsinline loop style="display:none"></video>
        <p id="stimulus-caption"></p>
        <div style="background:#eee;height:6px;border-radius:3px;margin-top:20px"><div id="progress-bar"></div></div>
    </div>

    <div id="p-questions" class="page">
        <h2>Avaliação</h2>
        <div id="q-container"></div>
        <button onclick="nextItem()">PRÓXIMO</button>
    </div>

    <div id="p-end" class="page">
        <h1>Finalizando...</h1>
        <p>Salvando dados. Não feche ainda.</p>
    </div>
</div>
<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
    const studyConfig = {{ study_config | tojson | safe }};
    const studyId = "{{ study_id }}";
    if (studyConfig) document.getElementById('welcome-text').innerText = studyConfig.welcome_message;

    let currentItem = 0;
    let results = [];
    let tempEmotions = [];
    let frameStats = { total: 0, valid: 0 };
    
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d');
    let captureInterval, progressInterval;

    async function initCamera() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
            video.srcObject = s;
            video.onloadedmetadata = () => setInterval(checkFace, 2000);
        } catch(e) { document.getElementById('status-msg').innerText = "Erro: Câmera bloqueada."; }
    }

    function capture() {
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        return canvas.toDataURL('image/jpeg', 0.7);
    }

    async function checkFace() {
        if (document.getElementById('p-welcome').style.display === 'none') return;
        const res = await fetch('/check_face', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({image:capture()}) });
        const d = await res.json();
        const st = document.getElementById('status-msg');
        if(d.face_detected) { st.innerText = "Rosto OK!"; st.style.color="green"; document.getElementById('btn-start').disabled=false; }
        else { st.innerText = "Rosto não detectado..."; st.style.color="orange"; document.getElementById('btn-start').disabled=true; }
    }

    function startExperiment() {
        if(!document.getElementById('participant_id').value) return alert("Digite seu ID");
        document.getElementById('video-wrapper').style.display='none';
        runItem(0);
    }

    function runItem(idx) {
        if(idx >= studyConfig.items.length) return finish();
        currentItem = idx;
        const item = studyConfig.items[idx];
        
        tempEmotions = [];
        frameStats = { total: 0, valid: 0 };

        const img = document.getElementById('stimulus-img');
        const vid = document.getElementById('stimulus-vid');
        
        if(item.file_type === 'video') {
            img.style.display='none'; vid.style.display='block'; vid.src = item.file_data;
        } else {
            vid.style.display='none'; img.style.display='block'; img.src = item.file_data;
        }
        document.getElementById('stimulus-caption').innerText = item.caption;
        
        showPage('p-stimulus');

        const durationMs = item.duration * 1000;
        const delay = 1000 / item.fps;
        let start = Date.now();

        captureInterval = setInterval(async () => {
            frameStats.total++;
            const imgData = capture();
            try {
                const res = await fetch('/analyze_emotion', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({image:imgData}) });
                const d = await res.json();
                if(d.status === 'success') {
                    tempEmotions.push(d.emotion);
                    frameStats.valid++;
                }
            } catch(e) { console.error(e); }
        }, delay);

        progressInterval = setInterval(() => {
            let elapsed = Date.now() - start;
            document.getElementById('progress-bar').style.width = (elapsed/durationMs*100)+"%";
            if(elapsed >= durationMs) {
                clearInterval(captureInterval);
                clearInterval(progressInterval);
                showQuestions(item.questions);
            }
        }, 50);
    }

    function showQuestions(q) {
        const c = document.getElementById('q-container');
        c.innerHTML = '';
        if(q.liking) c.innerHTML+='<label>Quanto gostou? (1-9)</label><input type="number" id="ans-lk" min="1" max="9" autocomplete="off">';
        if(q.emotions) c.innerHTML+='<label>Emoções sentidas?</label><input type="text" id="ans-em" placeholder="Ex: Feliz, Surpreso" autocomplete="off">';
        if(q.word) c.innerHTML+='<label>Uma palavra:</label><input type="text" id="ans-wd" autocomplete="off">';
        showPage('p-questions');
    }

    function nextItem() {
        results.push({
            stimulus: studyConfig.items[currentItem].name,
            liking: document.getElementById('ans-lk')?.value || "",
            word: document.getElementById('ans-wd')?.value || "",
            // CAPTURA O TEXTO DIGITADO (EXPLÍCITO)
            explicit_emotions: document.getElementById('ans-em')?.value || "", 
            emotions_list: tempEmotions,
            total_frames: frameStats.total,
            valid_frames: frameStats.valid,
            fps_config: studyConfig.items[currentItem].fps,
            duration_config: studyConfig.items[currentItem].duration
        });
        runItem(currentItem+1);
    }

    async function finish() {
        showPage('p-end');
        await fetch('/save_data', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                participant_id: document.getElementById('participant_id').value,
                study_id: studyId,
                results: results
            })
        });
        document.querySelector('#p-end').innerHTML = "<h1>Concluído!</h1><p>Pode fechar.</p>";
        video.srcObject.getTracks().forEach(t=>t.stop());
    }

    function showPage(id) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    initCamera();
</script>
</body>
</html>